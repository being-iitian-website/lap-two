// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  
  
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


enum TargetType {
  theory
  lecture
  revision
  solving
  mock
  challenge
}

enum TargetStatus {
  pending
  completed
  missed
}

enum RevisionStatus {
  pending
  completed
  missed
}

enum RevisionSource {
  manual
  target
}




model User_info {
  id         String   @id @default(uuid())
  name       String?
  email      String   @unique
  password   String?          
  image      String?
  provider   String   @default("local")
  googleId   String?  @unique
 

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  targets   Target[]
  revisions  Revision[] 
  focusSessions  FocusSession[]
  journals       Journal[]
  visionBoards   VisionBoard[]
  wellness DailyWellness[]
  xpRecord      UserXP?
  dailyXPAwards DailyXPAward[]
  dailyEfficiency DailyEfficiency[]
  notifications  Notification[]
  journalCredentials JournalCredential[]
}


model Target {
  id            String        @id @default(uuid())
  field         String
  subject       String
  title         String
  type          TargetType
  plannedHours  Float?
  actualHours   Float?
  questions     Int?         @default(0)
  startTime     DateTime?
  endTime       DateTime?
  carryForward  Boolean       @default(false)
  status        TargetStatus  @default(pending)
  dailyQuestion1 String?
  dailyAnswer1   String?
  dailyQuestion2 String?
  dailyAnswer2   String?
  responseDate   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  userId String
  user   User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  revisions Revision[] 
  journals       Journal[]
}


model Revision {
  id           String          @id @default(uuid())
  subject      String
  units        String[]        // Array of units
  notes        String?
  revisionDate DateTime
  status       RevisionStatus  @default(pending)
  source       RevisionSource

  // If revision came from a Target
  targetId String?
  target   Target? @relation(fields: [targetId], references: [id], onDelete: Cascade)

  // User relation
  userId String
  user   User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model FocusSession {
  id        String   @id @default(uuid())
  notes     String?
  startTime DateTime
  endTime   DateTime
  duration  Int      // duration in minutes (calculated in backend)

  userId String
  user   User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}


model Journal {
  id        String   @id @default(uuid())
  date      DateTime
  notes     String

  userId String
  user   User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  targetId String?
  target   Target? @relation(fields: [targetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}


model VisionBoard {
  id        String   @id @default(uuid())
  columns   Int
  rows      Int
  gap       Int

  userId    String
  user      User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     VisionBoardItem[]
}

model VisionBoardItem {
  id           String  @id @default(uuid())

  row          Int
  column       Int
  rowSpan      Int     @default(1)
  columnSpan   Int     @default(1)

  type         String  // "text" | "image"
  text         String?
  imageUrl     String?

  fontSize     Int?
  textColor    String?
  background   String?

  boardId      String
  board        VisionBoard @relation(fields: [boardId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}


model DailyWellness {
  id               String   @id @default(uuid())
  date             DateTime

  sleptAt          DateTime?
  actualSleepTime  DateTime?
  actualWakeTime   DateTime?

  sleepDurationMin Int?      // Sleep duration in minutes (420-540 = 7-9 hours)

  exerciseDone     Boolean  @default(false)
  meditationDone   Boolean  @default(false)

  waterIntakeMl    Int?     

  userId           String
  user             User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([userId, date])
}

model UserXP {
  id        String   @id @default(uuid())
  userId    String   @unique
  totalXP         Int@default(0)
  

  user      User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DailyXPAward {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  
  threshold String   // "focus_7h" or "focus_11h"
  xpAmount  Int      // 15 or 30

  user      User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, date, threshold])
  @@index([userId, date])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String   // "XP", "STREAK", "BADGE"
  title     String
  message   String
  metadata  Json?
  isRead    Boolean  @default(false)

  user      User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, isRead])
}

// Credentials to protect Journal updates per user
model JournalCredential {
  id           String   @id @default(uuid())
  userId       String   @unique
  username     String
  passwordHash String

  user         User_info @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// Daily efficiency tracking model
model DailyEfficiency {
  id                    String   @id @default(uuid())
  userId                String
  date                  DateTime // normalized to start of day
  
  // Daily metrics
  totalTargets          Int      // Total targets scheduled for the day
  completedTargets      Int      // Targets with status = 'completed'
  missedTargets         Int      // Targets with status = 'missed'
  pendingTargets        Int      // Targets with status = 'pending'
  
  // Efficiency calculation
  completionRate        Float    // (completedTargets / totalTargets) * 100
  timeEfficiency        Float    // (actualHours / plannedHours) * 100 for completed targets
  overallEfficiency     Float    // weighted average of completion + time efficiency
  
  user                  User_info @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([userId, date])
  @@index([userId, date])
}

